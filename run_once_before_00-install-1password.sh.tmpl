#!/bin/bash

set -e

{{- if not .install1Password }}
echo "Skipping 1Password installation (disabled in config)"
exit 0
{{- end }}

echo "Installing 1Password (required for SSH keys)..."
echo ""

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

{{- if eq .chezmoi.os "darwin" }}
# macOS installation using Homebrew
if ! command -v brew >/dev/null 2>&1; then
    echo -e "${YELLOW}Warning: Homebrew not found. Please install Homebrew first.${NC}"
    exit 1
fi

# 1Password
if ! brew list --cask 1password >/dev/null 2>&1; then
    echo "Installing 1Password..."
    brew install --cask 1password
else
    echo -e "${GREEN}✓${NC} 1Password is already installed"
fi

# 1password-cli
if ! command -v op >/dev/null 2>&1; then
    echo "Installing 1Password CLI..."
    brew install --cask 1password-cli
else
    echo -e "${GREEN}✓${NC} 1Password CLI is already installed"
fi

{{- else if eq .chezmoi.os "linux" }}
{{- if eq .chezmoi.osRelease.id "fedora" }}
# Fedora installation
if ! rpm -q 1password >/dev/null 2>&1; then
    echo "Installing 1Password..."
    sudo rpm --import https://downloads.1password.com/linux/keys/1password.asc
    sudo sh -c 'echo -e "[1password]\nname=1Password Stable Channel\nbaseurl=https://downloads.1password.com/linux/rpm/stable/\$basearch\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=\"https://downloads.1password.com/linux/keys/1password.asc\"" > /etc/yum.repos.d/1password.repo'
    sudo dnf install -y 1password
else
    echo -e "${GREEN}✓${NC} 1Password is already installed"
fi

# 1password-cli
if ! command -v op >/dev/null 2>&1; then
    echo "Installing 1Password CLI..."
    sudo dnf install -y 1password-cli
else
    echo -e "${GREEN}✓${NC} 1Password CLI is already installed"
fi

{{- else if or (eq .chezmoi.osRelease.id "debian") (eq .chezmoi.osRelease.id "ubuntu") }}
# Debian/Ubuntu installation
if ! dpkg -l 1password >/dev/null 2>&1; then
    echo "Installing 1Password..."
    curl -sS https://downloads.1password.com/linux/keys/1password.asc | sudo gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" | sudo tee /etc/apt/sources.list.d/1password.list
    sudo mkdir -p /etc/debsig/policies/AC2D62742012EA22/
    curl -sS https://downloads.1password.com/linux/debian/debsig/1password.pol | sudo tee /etc/debsig/policies/AC2D62742012EA22/1password.pol
    sudo mkdir -p /usr/share/debsig/keyrings/AC2D62742012EA22
    curl -sS https://downloads.1password.com/linux/keys/1password.asc | sudo gpg --dearmor --output /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg
    sudo apt-get update
    sudo apt-get install -y 1password 1password-cli
else
    echo -e "${GREEN}✓${NC} 1Password is already installed"
fi

# 1password-cli
if ! command -v op >/dev/null 2>&1; then
    echo "Installing 1Password CLI..."
    sudo apt-get install -y 1password-cli
else
    echo -e "${GREEN}✓${NC} 1Password CLI is already installed"
fi

{{- end }}
{{- end }}

echo ""
echo -e "${BLUE}========================================${NC}"
echo -e "${YELLOW}ACTION REQUIRED:${NC}"
echo ""
echo "1. Launch 1Password and sign in to your account"
echo "2. Go to Settings → Developer → SSH Agent"
echo "3. Enable 'Use the SSH agent'"
echo "4. Ensure your SSH key is stored in 1Password"
echo ""
echo -e "${BLUE}========================================${NC}"
echo ""
echo -n "Press Enter once you've completed these steps to continue installation..."
read

echo ""
echo -e "${GREEN}✓${NC} 1Password configured."
echo ""

# Check if chezmoi is using HTTPS and offer to switch to SSH
CHEZMOI_SOURCE_PATH="{{ .chezmoi.sourceDir }}"
if [ -d "$CHEZMOI_SOURCE_PATH/.git" ]; then
    REMOTE_URL=$(cd "$CHEZMOI_SOURCE_PATH" && git remote get-url origin 2>/dev/null || echo "")

    if [[ "$REMOTE_URL" == https://* ]]; then
        echo -e "${YELLOW}Detected chezmoi repository is using HTTPS.${NC}"
        echo "With 1Password SSH agent configured, you can now use SSH for git operations."
        echo ""
        echo -n "Would you like to switch chezmoi repository to SSH? (y/n): "
        read -r SWITCH_TO_SSH

        if [[ "$SWITCH_TO_SSH" =~ ^[Yy]$ ]]; then
            # Convert HTTPS URL to SSH URL
            SSH_URL=$(echo "$REMOTE_URL" | sed 's|https://github.com/|git@github.com:|')
            cd "$CHEZMOI_SOURCE_PATH"
            git remote set-url origin "$SSH_URL"
            echo -e "${GREEN}✓${NC} Switched chezmoi repository to SSH: $SSH_URL"
        else
            echo "Keeping HTTPS for chezmoi repository."
        fi
        echo ""
    fi
fi

echo "Continuing with installation..."
echo ""
