#!/bin/bash

set -e

echo "Installing development tools..."

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Ask about AI tools
echo ""
read -p "Install AI tools (opencode)? (y/n): " -n 1 -r
echo ""
INSTALL_AI_TOOLS=$REPLY

check_installed() {
    if command -v "$1" >/dev/null 2>&1; then
        echo -e "${GREEN}✓${NC} $1 is already installed"
        return 0
    else
        return 1
    fi
}

{{- if eq .chezmoi.os "darwin" }}
# macOS installations using Homebrew
echo "Installing tools via Homebrew..."

if ! command -v brew >/dev/null 2>&1; then
    echo -e "${YELLOW}Warning: Homebrew not found. Please install Homebrew first.${NC}"
    exit 1
fi

# fzf
check_installed fzf || brew install fzf

# ripgrep
check_installed rg || brew install ripgrep

# neovim
check_installed nvim || brew install neovim

# aws-cli
check_installed aws || brew install awscli

# kubectl
check_installed kubectl || brew install kubectl

# tfenv
check_installed tfenv || brew install tfenv

# n (node version manager)
check_installed n || brew install n

# Docker Desktop
if ! check_installed docker; then
    brew install --cask docker
fi

# htop
check_installed htop || brew install htop

# btop
check_installed btop || brew install btop

# curl (usually pre-installed but ensure it's there)
check_installed curl || brew install curl

# zip/unzip
check_installed zip || brew install zip
check_installed unzip || brew install unzip

# fd (modern find)
check_installed fd || brew install fd

# lazygit
check_installed lazygit || brew install lazygit

# k9s (Kubernetes UI)
check_installed k9s || brew install k9s

# luarocks
check_installed luarocks || brew install luarocks

# jq (JSON processor)
check_installed jq || brew install jq

# starship (shell prompt)
check_installed starship || brew install starship

# bat (modern cat)
check_installed bat || brew install bat

# tree-sitter
check_installed tree-sitter || brew install tree-sitter

# e1s (AWS ECS CLI)
if ! check_installed e1s; then
    brew tap keidarcy/tap
    brew install keidarcy/tap/e1s
fi

# opencode
if [[ $INSTALL_AI_TOOLS =~ ^[Yy]$ ]] && ! check_installed opencode; then
    curl -fsSL https://opencode.ai/install | bash -s -- --no-modify-path
fi

# AWS Session Manager Plugin
if ! check_installed session-manager-plugin; then
    curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/mac_arm64/session-manager-plugin.pkg" -o "/tmp/session-manager-plugin.pkg"
    sudo installer -pkg /tmp/session-manager-plugin.pkg -target /
    sudo ln -s /usr/local/sessionmanagerplugin/bin/session-manager-plugin /usr/local/bin/session-manager-plugin
    rm /tmp/session-manager-plugin.pkg
fi

{{- else if eq .chezmoi.os "linux" }}
{{- if eq .chezmoi.osRelease.id "fedora" }}
# Fedora installations

# Essential build tools (needed for other installations)
if ! check_installed zip; then
    sudo dnf install -y zip unzip curl make gcc gcc-c++
fi

# Podman (Docker-compatible container runtime - Fedora's native solution)
if ! check_installed podman; then
    echo "Installing Podman..."
    sudo dnf install -y podman
fi

# Podman Docker compatibility layer
if ! check_installed docker; then
    echo "Installing Docker CLI compatibility for Podman..."
    sudo dnf install -y podman-docker podman-compose
    # podman-docker provides 'docker' command that uses podman underneath
    echo -e "${GREEN}✓${NC} Docker CLI compatibility installed"
fi

# fzf
if ! check_installed fzf; then
    sudo dnf install -y fzf
fi

# ripgrep
if ! check_installed rg; then
    sudo dnf install -y ripgrep
fi

# neovim
if ! check_installed nvim; then
    sudo dnf install -y neovim python3-neovim
fi

# aws-cli
if ! check_installed aws; then
    sudo dnf install -y awscli
fi

# kubectl
if ! check_installed kubectl; then
    sudo dnf install -y kubernetes-client
fi

# n (node version manager)
if ! check_installed n; then
    if check_installed node && check_installed npm; then
        echo "Installing n via npm (Node.js already present)..."
        sudo npm install -g n
    elif [ -d "$HOME/n" ]; then
        echo -e "${YELLOW}n directory already exists, skipping installation${NC}"
    else
        echo "Installing n and Node.js..."
        curl -L https://bit.ly/n-install | bash -s -- -y
    fi
fi

# Note: On Fedora, we use Podman (installed at the top) instead of Docker
# Podman provides docker CLI compatibility via the podman-docker package

# htop
if ! check_installed htop; then
    sudo dnf install -y htop
fi

# btop
if ! check_installed btop; then
    sudo dnf install -y btop
fi

# fd
if ! check_installed fd; then
    sudo dnf install -y fd-find
fi

# lazygit
if ! check_installed lazygit; then
    sudo dnf copr enable -y atim/lazygit
    sudo dnf install -y lazygit
fi

# k9s
if ! check_installed k9s; then
    sudo dnf copr enable -y luminoso/k9s
    sudo dnf install -y k9s
fi

# luarocks
if ! check_installed luarocks; then
    sudo dnf install -y luarocks
fi

# jq (JSON processor)
if ! check_installed jq; then
    sudo dnf install -y jq
fi

# starship (shell prompt)
if ! check_installed starship; then
    curl -sS https://starship.rs/install.sh | sh -s -- -y
fi

# bat (modern cat)
if ! check_installed bat; then
    sudo dnf install -y bat
fi

# e1s (AWS ECS CLI)
if ! check_installed e1s; then
    ARCH=$(uname -m)
    if [ "$ARCH" = "x86_64" ]; then
        E1S_ARCH="amd64"
    elif [ "$ARCH" = "aarch64" ]; then
        E1S_ARCH="arm64"
    fi
    E1S_VERSION="1.0.52"
    curl -sL "https://github.com/keidarcy/e1s/releases/download/v${E1S_VERSION}/e1s_${E1S_VERSION}_linux_${E1S_ARCH}.tar.gz" -o /tmp/e1s.tar.gz
    tar -xzf /tmp/e1s.tar.gz -C /tmp
    sudo mv /tmp/e1s /usr/local/bin/
    rm /tmp/e1s.tar.gz
fi

# opencode
if [[ $INSTALL_AI_TOOLS =~ ^[Yy]$ ]] && ! check_installed opencode; then
    curl -fsSL https://opencode.ai/install | bash -s -- --no-modify-path
fi

# AWS Session Manager Plugin
if ! check_installed session-manager-plugin; then
    sudo dnf install -y https://s3.amazonaws.com/session-manager-downloads/plugin/latest/linux_64bit/session-manager-plugin.rpm
fi

{{- else if or (eq .chezmoi.osRelease.id "debian") (eq .chezmoi.osRelease.id "ubuntu") }}
# Debian/Ubuntu installations

# Essential build tools (needed for other installations)
if ! check_installed zip; then
    sudo apt-get update
    sudo apt-get install -y zip unzip make build-essential
fi

# curl
if ! check_installed curl; then
    sudo apt-get install -y curl
fi

# fzf
if ! check_installed fzf; then
    sudo apt-get install -y fzf
fi

# ripgrep
if ! check_installed rg; then
    sudo apt-get install -y ripgrep
fi

# neovim
if ! check_installed nvim; then
    sudo apt-get install -y neovim python3-neovim
fi

# aws-cli
if ! check_installed aws; then
    # Install AWS CLI v2 (recommended)
    if [ ! -f /tmp/awscliv2.zip ]; then
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
        unzip -q /tmp/awscliv2.zip -d /tmp
        sudo /tmp/aws/install
        rm -rf /tmp/aws /tmp/awscliv2.zip
    fi
fi

# kubectl
if ! check_installed kubectl; then
    curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
    rm kubectl
fi

# n (node version manager)
if ! check_installed n; then
    if check_installed node && check_installed npm; then
        echo "Installing n via npm (Node.js already present)..."
        sudo npm install -g n
    elif [ -d "$HOME/n" ]; then
        echo -e "${YELLOW}n directory already exists, skipping installation${NC}"
    else
        echo "Installing n and Node.js..."
        curl -L https://bit.ly/n-install | bash -s -- -y
    fi
fi

# Docker + docker-compose
if ! check_installed docker; then
    echo "Installing Docker using official script..."
    curl -fsSL https://get.docker.com -o /tmp/get-docker.sh
    sudo sh /tmp/get-docker.sh
    rm /tmp/get-docker.sh
    sudo systemctl enable --now docker
    sudo usermod -aG docker $USER
    echo -e "${YELLOW}Note: You may need to log out and back in for Docker group membership to take effect${NC}"
fi

# htop
if ! check_installed htop; then
    sudo apt-get install -y htop
fi

# btop
if ! check_installed btop; then
    sudo apt-get install -y btop
fi

# fd (note: command is 'fdfind' on Debian/Ubuntu)
if ! check_installed fdfind && ! check_installed fd; then
    sudo apt-get install -y fd-find
fi

# lazygit
if ! check_installed lazygit; then
    LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
    curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
    tar xf lazygit.tar.gz lazygit
    sudo install lazygit /usr/local/bin
    rm lazygit lazygit.tar.gz
fi

# k9s
if ! check_installed k9s; then
    K9S_VERSION=$(curl -s https://api.github.com/repos/derailed/k9s/releases/latest | grep -Po '"tag_name": "\K[^"]*')
    curl -Lo k9s.tar.gz "https://github.com/derailed/k9s/releases/latest/download/k9s_Linux_amd64.tar.gz"
    tar xf k9s.tar.gz k9s
    sudo install k9s /usr/local/bin
    rm k9s k9s.tar.gz
fi

# luarocks
if ! check_installed luarocks; then
    sudo apt-get install -y luarocks
fi

# jq (JSON processor)
if ! check_installed jq; then
    sudo apt-get install -y jq
fi

# starship (shell prompt)
if ! check_installed starship; then
    curl -sS https://starship.rs/install.sh | sh -s -- -y
fi

# bat (modern cat - installed as batcat on Debian/Ubuntu)
if ! check_installed bat && ! check_installed batcat; then
    sudo apt-get install -y bat
fi

# e1s (AWS ECS CLI)
if ! check_installed e1s; then
    ARCH=$(uname -m)
    if [ "$ARCH" = "x86_64" ]; then
        E1S_ARCH="amd64"
    elif [ "$ARCH" = "aarch64" ]; then
        E1S_ARCH="arm64"
    fi
    E1S_VERSION="1.0.52"
    curl -sL "https://github.com/keidarcy/e1s/releases/download/v${E1S_VERSION}/e1s_${E1S_VERSION}_linux_${E1S_ARCH}.tar.gz" -o /tmp/e1s.tar.gz
    tar -xzf /tmp/e1s.tar.gz -C /tmp
    sudo mv /tmp/e1s /usr/local/bin/
    rm /tmp/e1s.tar.gz
fi

# opencode
if [[ $INSTALL_AI_TOOLS =~ ^[Yy]$ ]] && ! check_installed opencode; then
    curl -fsSL https://opencode.ai/install | bash -s -- --no-modify-path
fi

# AWS Session Manager Plugin
if ! check_installed session-manager-plugin; then
    curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" -o "/tmp/session-manager-plugin.deb"
    sudo dpkg -i /tmp/session-manager-plugin.deb
    rm /tmp/session-manager-plugin.deb
fi

{{- else }}
# Generic Linux
echo -e "${YELLOW}Generic Linux detected. Attempting installation...${NC}"

# fzf
if ! check_installed fzf; then
    if command -v dnf >/dev/null 2>&1; then
        sudo dnf install -y fzf
    elif command -v apt-get >/dev/null 2>&1; then
        sudo apt-get update && sudo apt-get install -y fzf
    fi
fi

# ripgrep
if ! check_installed rg; then
    if command -v dnf >/dev/null 2>&1; then
        sudo dnf install -y ripgrep
    elif command -v apt-get >/dev/null 2>&1; then
        sudo apt-get install -y ripgrep
    fi
fi

# neovim
if ! check_installed nvim; then
    if command -v dnf >/dev/null 2>&1; then
        sudo dnf install -y neovim python3-neovim
    elif command -v apt-get >/dev/null 2>&1; then
        sudo apt-get install -y neovim python3-neovim
    fi
fi

# aws-cli
if ! check_installed aws; then
    if command -v dnf >/dev/null 2>&1; then
        sudo dnf install -y awscli
    elif command -v apt-get >/dev/null 2>&1; then
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
        unzip -q /tmp/awscliv2.zip -d /tmp
        sudo /tmp/aws/install
        rm -rf /tmp/aws /tmp/awscliv2.zip
    fi
fi

# kubectl
if ! check_installed kubectl; then
    curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
    rm kubectl
fi

# AWS Session Manager Plugin
if ! check_installed session-manager-plugin; then
    if command -v dnf >/dev/null 2>&1; then
        sudo dnf install -y https://s3.amazonaws.com/session-manager-downloads/plugin/latest/linux_64bit/session-manager-plugin.rpm
    elif command -v apt-get >/dev/null 2>&1; then
        curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" -o "/tmp/session-manager-plugin.deb"
        sudo dpkg -i /tmp/session-manager-plugin.deb
        rm /tmp/session-manager-plugin.deb
    fi
fi
{{- end }}

# tfenv (Linux - all distributions)
if ! check_installed tfenv; then
    echo "Installing tfenv..."
    if [ ! -d "$HOME/.tfenv" ]; then
        git clone --depth=1 https://github.com/tfutils/tfenv.git "$HOME/.tfenv"
        # Export for current session (PATH is managed in .zshrc by chezmoi)
        export PATH="$HOME/.tfenv/bin:$PATH"
        echo -e "${GREEN}✓${NC} tfenv installed successfully"
    fi
fi

{{- end }}

{{- if eq .chezmoi.os "linux" }}
# tree-sitter (Linux - installed from GitHub releases)
if ! check_installed tree-sitter; then
    echo "Installing tree-sitter from GitHub releases..."
    TREE_SITTER_VERSION=$(curl -s "https://api.github.com/repos/tree-sitter/tree-sitter/releases/latest" | grep -Po '"tag_name": "\K[^"]*')
    ARCH=$(uname -m)
    if [ "$ARCH" = "x86_64" ]; then
        TREE_SITTER_BINARY="tree-sitter-linux-x64.gz"
    elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
        TREE_SITTER_BINARY="tree-sitter-linux-arm64.gz"
    fi
    curl -sL "https://github.com/tree-sitter/tree-sitter/releases/download/${TREE_SITTER_VERSION}/${TREE_SITTER_BINARY}" -o /tmp/tree-sitter.gz
    gunzip /tmp/tree-sitter.gz
    chmod +x /tmp/tree-sitter
    sudo mv /tmp/tree-sitter /usr/local/bin/
    echo -e "${GREEN}✓${NC} tree-sitter installed from GitHub releases"
fi
{{- end }}

echo ""
echo -e "${GREEN}All tools installed successfully!${NC}"
echo ""
echo "Installed tools:"
command -v podman >/dev/null 2>&1 && echo "  - podman: $(podman --version | cut -d' ' -f3)"
command -v docker >/dev/null 2>&1 && echo "  - docker: $(docker --version | cut -d' ' -f3 | tr -d ',')"
command -v n >/dev/null 2>&1 && echo "  - n: $(n --version)"
command -v fzf >/dev/null 2>&1 && echo "  - fzf: $(fzf --version)"
command -v rg >/dev/null 2>&1 && echo "  - ripgrep: $(rg --version | head -n1)"
command -v nvim >/dev/null 2>&1 && echo "  - neovim: $(nvim --version | head -n1)"
command -v aws >/dev/null 2>&1 && echo "  - aws-cli: $(aws --version 2>&1 | cut -d' ' -f1)"
command -v kubectl >/dev/null 2>&1 && echo "  - kubectl: $(kubectl version --client 2>/dev/null | grep 'Client Version' | sed 's/.*: //' | cut -d' ' -f1)"
[ -f "$HOME/.tfenv/bin/tfenv" ] && echo "  - tfenv: $($HOME/.tfenv/bin/tfenv --version)"
command -v htop >/dev/null 2>&1 && echo "  - htop: $(htop --version | head -n1 | cut -d' ' -f2)"
command -v btop >/dev/null 2>&1 && echo "  - btop: $(btop --version 2>&1 | head -n1 | sed -E 's/.*([0-9]+\.[0-9]+\.[0-9]+).*/\1/')"
command -v curl >/dev/null 2>&1 && echo "  - curl: $(curl --version 2>&1 | head -n1 | cut -d' ' -f2)"
if command -v fd >/dev/null 2>&1; then
    echo "  - fd: $(fd --version 2>&1 | cut -d' ' -f2)"
elif command -v fdfind >/dev/null 2>&1; then
    echo "  - fdfind: $(fdfind --version 2>&1 | cut -d' ' -f2)"
fi
command -v lazygit >/dev/null 2>&1 && echo "  - lazygit: $(lazygit --version 2>&1 | grep 'version=' | sed 's/.*version=//' | cut -d',' -f1 | head -n1)"
command -v k9s >/dev/null 2>&1 && echo "  - k9s: $(k9s version -s 2>&1 | head -n1 | awk '{print $2}')"
command -v luarocks >/dev/null 2>&1 && echo "  - luarocks: $(luarocks --version | head -n1 | cut -d' ' -f2)"
command -v op >/dev/null 2>&1 && echo "  - 1password-cli: $(op --version)"
command -v jq >/dev/null 2>&1 && echo "  - jq: $(jq --version | cut -d'-' -f2)"
command -v starship >/dev/null 2>&1 && echo "  - starship: $(starship --version | head -n1 | cut -d' ' -f2)"
command -v tree-sitter >/dev/null 2>&1 && echo "  - tree-sitter: $(tree-sitter --version 2>&1 | head -n1 | awk '{print $2}')"
if command -v bat >/dev/null 2>&1; then
    echo "  - bat: $(bat --version | cut -d' ' -f2)"
elif command -v batcat >/dev/null 2>&1; then
    echo "  - bat: $(batcat --version | cut -d' ' -f2)"
fi
command -v e1s >/dev/null 2>&1 && echo "  - e1s: $(e1s -v 2>&1 | grep 'Current:' | awk '{print $2}')"
command -v session-manager-plugin >/dev/null 2>&1 && echo "  - session-manager-plugin: $(session-manager-plugin --version 2>&1)"
[ -x "$HOME/.opencode/bin/opencode" ] && echo "  - opencode: $($HOME/.opencode/bin/opencode --version 2>&1)"
