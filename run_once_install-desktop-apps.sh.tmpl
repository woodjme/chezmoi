#!/bin/bash

set -e

{{- if not .installDesktopApps }}
echo "Skipping desktop applications (disabled in config)"
exit 0
{{- end }}

echo "Installing desktop applications..."

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

check_installed() {
    if command -v "$1" >/dev/null 2>&1; then
        echo -e "${GREEN}✓${NC} $1 is already installed"
        return 0
    else
        return 1
    fi
}

{{- if eq .chezmoi.os "darwin" }}
# macOS installations using Homebrew
echo "Installing desktop apps via Homebrew..."

if ! command -v brew >/dev/null 2>&1; then
    echo -e "${YELLOW}Warning: Homebrew not found. Please install Homebrew first.${NC}"
    exit 1
fi

# Fira Code font
if ! brew list --cask font-fira-code >/dev/null 2>&1; then
    echo "Installing Fira Code font..."
    brew install --cask font-fira-code
else
    echo -e "${GREEN}✓${NC} Fira Code font is already installed"
fi

# Ghostty terminal
if ! check_installed ghostty; then
    echo "Installing Ghostty..."
    brew install --cask ghostty
fi

# 1Password
if ! brew list --cask 1password >/dev/null 2>&1; then
    echo "Installing 1Password..."
    brew install --cask 1password
else
    echo -e "${GREEN}✓${NC} 1Password is already installed"
fi

# Brave browser
if ! brew list --cask brave-browser >/dev/null 2>&1; then
    echo "Installing Brave browser..."
    brew install --cask brave-browser
else
    echo -e "${GREEN}✓${NC} Brave browser is already installed"
fi

{{- else if eq .chezmoi.os "linux" }}
{{- if eq .chezmoi.osRelease.id "fedora" }}
# Fedora installations

# Fira Code font
if ! fc-list | grep -qi "fira code"; then
    echo "Installing Fira Code font..."
    sudo dnf install -y fira-code-fonts
else
    echo -e "${GREEN}✓${NC} Fira Code font is already installed"
fi

# Ghostty terminal
if ! check_installed ghostty; then
    echo "Installing Ghostty..."
    # Enable COPR repository for Ghostty (scottames repo has newer versions)
    sudo dnf copr enable -y scottames/ghostty
    sudo dnf install -y ghostty
fi

# 1Password
if ! rpm -q 1password >/dev/null 2>&1; then
    echo "Installing 1Password..."
    sudo rpm --import https://downloads.1password.com/linux/keys/1password.asc
    sudo sh -c 'echo -e "[1password]\nname=1Password Stable Channel\nbaseurl=https://downloads.1password.com/linux/rpm/stable/\$basearch\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=\"https://downloads.1password.com/linux/keys/1password.asc\"" > /etc/yum.repos.d/1password.repo'
    sudo dnf install -y 1password
else
    echo -e "${GREEN}✓${NC} 1Password is already installed"
fi

# Brave browser
if ! rpm -q brave-browser >/dev/null 2>&1; then
    echo "Installing Brave browser..."
    sudo dnf install -y dnf-plugins-core
    sudo dnf config-manager --add-repo https://brave-browser-rpm-release.s3.brave.com/brave-browser.repo
    sudo rpm --import https://brave-browser-rpm-release.s3.brave.com/brave-core.asc
    sudo dnf install -y brave-browser
else
    echo -e "${GREEN}✓${NC} Brave browser is already installed"
fi

{{- else if or (eq .chezmoi.osRelease.id "debian") (eq .chezmoi.osRelease.id "ubuntu") }}
# Debian/Ubuntu installations

# Fira Code font
if ! fc-list | grep -qi "fira code"; then
    echo "Installing Fira Code font..."
    sudo apt-get update
    sudo apt-get install -y fonts-firacode
else
    echo -e "${GREEN}✓${NC} Fira Code font is already installed"
fi

# Ghostty terminal
if ! check_installed ghostty; then
    echo "Installing Ghostty..."
    echo -e "${YELLOW}Note: Ghostty may need to be built from source on Debian/Ubuntu${NC}"
    echo "Visit: https://github.com/ghostty-org/ghostty for installation instructions"
    # You can add build-from-source instructions here if needed
fi

# 1Password
if ! dpkg -l 1password >/dev/null 2>&1; then
    echo "Installing 1Password..."
    curl -sS https://downloads.1password.com/linux/keys/1password.asc | sudo gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" | sudo tee /etc/apt/sources.list.d/1password.list
    sudo mkdir -p /etc/debsig/policies/AC2D62742012EA22/
    curl -sS https://downloads.1password.com/linux/debian/debsig/1password.pol | sudo tee /etc/debsig/policies/AC2D62742012EA22/1password.pol
    sudo mkdir -p /usr/share/debsig/keyrings/AC2D62742012EA22
    curl -sS https://downloads.1password.com/linux/keys/1password.asc | sudo gpg --dearmor --output /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg
    sudo apt-get update
    sudo apt-get install -y 1password
else
    echo -e "${GREEN}✓${NC} 1Password is already installed"
fi

# Brave browser
if ! dpkg -l brave-browser >/dev/null 2>&1; then
    echo "Installing Brave browser..."
    sudo apt-get install -y curl
    sudo curl -fsSLo /usr/share/keyrings/brave-browser-archive-keyring.gpg https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg
    echo "deb [signed-by=/usr/share/keyrings/brave-browser-archive-keyring.gpg] https://brave-browser-apt-release.s3.brave.com/ stable main" | sudo tee /etc/apt/sources.list.d/brave-browser-release.list
    sudo apt-get update
    sudo apt-get install -y brave-browser
else
    echo -e "${GREEN}✓${NC} Brave browser is already installed"
fi

{{- else }}
# Generic Linux
echo -e "${YELLOW}Generic Linux detected. Attempting installation...${NC}"

# Fira Code font
if ! fc-list | grep -qi "fira code"; then
    if command -v dnf >/dev/null 2>&1; then
        sudo dnf install -y fira-code-fonts
    elif command -v apt-get >/dev/null 2>&1; then
        sudo apt-get update && sudo apt-get install -y fonts-firacode
    fi
else
    echo -e "${GREEN}✓${NC} Fira Code font is already installed"
fi

# Ghostty terminal
if ! check_installed ghostty; then
    echo -e "${YELLOW}Please install Ghostty manually from: https://github.com/ghostty-org/ghostty${NC}"
fi

{{- end }}
{{- end }}

echo ""
echo -e "${GREEN}Desktop applications installation complete!${NC}"
echo ""
echo "Installed:"
fc-list | grep -qi "fira code" && echo "  - Fira Code font ✓"
if command -v ghostty >/dev/null 2>&1; then
    GHOSTTY_VERSION=$(ghostty --version 2>&1 | head -n1)
    echo "  - Ghostty: $GHOSTTY_VERSION"
fi
