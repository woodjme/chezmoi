#!/bin/bash

set -e

{{- if not .installDesktopApps }}
echo "Skipping desktop applications (disabled in config)"
exit 0
{{- end }}

echo "Installing desktop applications..."

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

check_installed() {
    if command -v "$1" >/dev/null 2>&1; then
        echo -e "${GREEN}✓${NC} $1 is already installed"
        return 0
    else
        return 1
    fi
}

{{- if eq .chezmoi.os "darwin" }}
# macOS installations using Homebrew
echo "Installing desktop apps via Homebrew..."

if ! command -v brew >/dev/null 2>&1; then
    echo -e "${YELLOW}Warning: Homebrew not found. Please install Homebrew first.${NC}"
    exit 1
fi

# Fira Code font
if ! brew list --cask font-fira-code >/dev/null 2>&1; then
    echo "Installing Fira Code font..."
    brew install --cask font-fira-code
else
    echo -e "${GREEN}✓${NC} Fira Code font is already installed"
fi

# Ghostty terminal
if ! check_installed ghostty; then
    echo "Installing Ghostty..."
    brew install --cask ghostty
fi

# Brave browser
if ! brew list --cask brave-browser >/dev/null 2>&1; then
    echo "Installing Brave browser..."
    brew install --cask brave-browser
else
    echo -e "${GREEN}✓${NC} Brave browser is already installed"
fi

# Obsidian
if ! brew list --cask obsidian >/dev/null 2>&1; then
    echo "Installing Obsidian..."
    brew install --cask obsidian
else
    echo -e "${GREEN}✓${NC} Obsidian is already installed"
fi

# Todoist
if ! brew list --cask todoist >/dev/null 2>&1; then
    echo "Installing Todoist..."
    brew install --cask todoist
else
    echo -e "${GREEN}✓${NC} Todoist is already installed"
fi

{{- else if eq .chezmoi.os "linux" }}
{{- if eq .chezmoi.osRelease.id "fedora" }}
# Fedora installations

# Fira Code font
if ! fc-list | grep -qi "fira code"; then
    echo "Installing Fira Code font..."
    sudo dnf install -y fira-code-fonts
else
    echo -e "${GREEN}✓${NC} Fira Code font is already installed"
fi

# Ghostty terminal
if ! check_installed ghostty; then
    echo "Installing Ghostty..."
    # Enable COPR repository for Ghostty (scottames repo has newer versions)
    sudo dnf copr enable -y scottames/ghostty
    sudo dnf install -y ghostty
fi

# Brave browser
if ! check_installed brave-browser; then
    echo "Installing Brave browser..."
    curl -fsS https://dl.brave.com/install.sh | sh
else
    echo -e "${GREEN}✓${NC} Brave browser is already installed"
fi

# Flatpak (usually pre-installed on Fedora)
if ! check_installed flatpak; then
    echo "Installing Flatpak..."
    sudo dnf install -y flatpak
else
    echo -e "${GREEN}✓${NC} Flatpak is already installed"
fi

# Add Flathub repository
if ! flatpak remotes | grep -q flathub; then
    echo "Adding Flathub repository..."
    flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
fi

# Obsidian
if ! flatpak list | grep -q "md.obsidian.Obsidian"; then
    echo "Installing Obsidian..."
    flatpak install -y flathub md.obsidian.Obsidian
else
    echo -e "${GREEN}✓${NC} Obsidian is already installed"
fi

# Todoist
if ! flatpak list | grep -q "com.todoist.Todoist"; then
    echo "Installing Todoist..."
    flatpak install -y flathub com.todoist.Todoist
else
    echo -e "${GREEN}✓${NC} Todoist is already installed"
fi

{{- else if or (eq .chezmoi.osRelease.id "debian") (eq .chezmoi.osRelease.id "ubuntu") }}
# Debian/Ubuntu installations

# Fira Code font
if ! fc-list | grep -qi "fira code"; then
    echo "Installing Fira Code font..."
    sudo apt-get update
    sudo apt-get install -y fonts-firacode
else
    echo -e "${GREEN}✓${NC} Fira Code font is already installed"
fi

# Ghostty terminal
if ! check_installed ghostty; then
    echo "Installing Ghostty..."
    echo -e "${YELLOW}Note: Ghostty may need to be built from source on Debian/Ubuntu${NC}"
    echo "Visit: https://github.com/ghostty-org/ghostty for installation instructions"
    # You can add build-from-source instructions here if needed
fi

# Brave browser
if ! check_installed brave-browser; then
    echo "Installing Brave browser..."
    curl -fsS https://dl.brave.com/install.sh | sh
else
    echo -e "${GREEN}✓${NC} Brave browser is already installed"
fi

# Flatpak
if ! check_installed flatpak; then
    echo "Installing Flatpak..."
    sudo apt-get update
    sudo apt-get install -y flatpak
else
    echo -e "${GREEN}✓${NC} Flatpak is already installed"
fi

# Add Flathub repository
if ! flatpak remotes | grep -q flathub; then
    echo "Adding Flathub repository..."
    flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
fi

# Obsidian
if ! flatpak list | grep -q "md.obsidian.Obsidian"; then
    echo "Installing Obsidian..."
    flatpak install -y flathub md.obsidian.Obsidian
else
    echo -e "${GREEN}✓${NC} Obsidian is already installed"
fi

# Todoist
if ! flatpak list | grep -q "com.todoist.Todoist"; then
    echo "Installing Todoist..."
    flatpak install -y flathub com.todoist.Todoist
else
    echo -e "${GREEN}✓${NC} Todoist is already installed"
fi

{{- else }}
# Generic Linux
echo -e "${YELLOW}Generic Linux detected. Attempting installation...${NC}"

# Fira Code font
if ! fc-list | grep -qi "fira code"; then
    if command -v dnf >/dev/null 2>&1; then
        sudo dnf install -y fira-code-fonts
    elif command -v apt-get >/dev/null 2>&1; then
        sudo apt-get update && sudo apt-get install -y fonts-firacode
    fi
else
    echo -e "${GREEN}✓${NC} Fira Code font is already installed"
fi

# Ghostty terminal
if ! check_installed ghostty; then
    echo -e "${YELLOW}Please install Ghostty manually from: https://github.com/ghostty-org/ghostty${NC}"
fi

# Brave browser
if ! check_installed brave-browser; then
    echo "Installing Brave browser..."
    curl -fsS https://dl.brave.com/install.sh | sh
else
    echo -e "${GREEN}✓${NC} Brave browser is already installed"
fi

{{- end }}
{{- end }}

echo ""
echo -e "${GREEN}Desktop applications installation complete!${NC}"
echo ""
echo "Installed:"
fc-list | grep -qi "fira code" && echo "  - Fira Code font ✓"
if command -v ghostty >/dev/null 2>&1; then
    GHOSTTY_VERSION=$(ghostty --version 2>&1 | head -n1)
    echo "  - Ghostty: $GHOSTTY_VERSION"
fi
